#!/usr/bin/env bash

BUILD_DIR=$1 # The app directory, usually /app. This will have the app source initially. Whatever is left here will be persisted.
CACHE_DIR=$2 # The contents of CACHE_DIR will be persisted between builds so we can use it to speed the builds up
ENV_DIR=$3     # An envdir directory of the app's environment variables

set -e

SOURCE=${BUILD_DIR}/config/database.yml

RELPATH="$(echo ${BACKUP_DATABASE_YML:-${BUILD_DIR}/config/database.yml.backup} | sed -e 's%/app/%/%g')"
DESTINATION="${BUILD_DIR}/${RELPATH}"
mkdir -p $(dirname ${DESTINATION})

if [ -f $SOURCE ]; then
  echo Copying $SOURCE to $DESTINATION
  cp -f $SOURCE $DESTINATION
fi

BACKUP_DATABASE_YML=${BACKUP_DATABASE_YML:-/app/config/database.yml.backup}
echo "Exporting BACKUP_DATABASE_YML=${BACKUP_DATABASE_YML}"

mkdir -p $BUILD_DIR/.profile.d
echo "export BACKUP_DATABASE_YML=${BACKUP_DATABASE_YML}" > $BUILD_DIR/.profile.d/backup-database-yml.sh
chmod 755 $BUILD_DIR/.profile.d/backup-database-yml.sh

# Pass this back to the build environment
export BACKUP_DATABASE_YML
exit 0
